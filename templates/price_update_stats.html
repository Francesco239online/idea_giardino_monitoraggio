<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiche aggiornamento prezzi</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
        }
        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group {
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        .form-group-row {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover {
            background-color: #218838;
        }
        .stats {
            margin-top: 20px;
        }
        .stats h2 {
            text-align: center;
            font-size: 2em;
        }
        .stats p {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .vendor-stats {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        .vendor-stats h3 {
            text-align: center;
            font-size: 1.5em;
        }
        .vendor-stats ul {
            list-style: none;
            padding: 0;
        }
        .vendor-stats li {
            margin: 5px 0;
            font-size: 1.2em;
        }
        .menu-icon {
            font-size: 30px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }
        .sidebar a {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
            transition: 0.3s;
        }
        .sidebar a:hover {
            background-color: #575757;
        }
        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 5px;
            font-size: 36px;
            margin-left: 50px;
        }
        .price-changes-sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 2;
            top: 0;
            right: 0;
            background-color: #f9f9f9;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            border-left: 1px solid #ccc;
        }
        .price-changes-sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        .price-changes-sidebar h2 {
            padding: 10px;
            font-size: 1.5em;
            color: #333;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .price-change {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .price-change p {
            margin: 5px 0;
        }
        .price-change .product-title {
            font-weight: bold;
            font-size: 1.2em;
            color: #007bff;
        }
        .price-change .product-url {
            font-size: 0.9em;
            color: #555;
            word-wrap: break-word;
        }
        .price-change .old-price, .price-change .new-price {
            font-size: 1em;
            color: #333;
        }
        .price-change .timestamp {
            font-size: 0.8em;
            color: #888;
        }
        .loading-bar {
            width: 100%;
            background-color: #f3f3f3;
            margin: 20px 0;
        }
        .loading-bar-fill {
            height: 30px;
            width: 0;
            background-color: #4caf50;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="menu" class="menu-icon" onclick="openNav()">&#9776;</div>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="/">Monitoraggio Concorrenza</a>
        <a href="/search-competitor">Ricerca per concorrente</a>
        <a href="/price-update-stats">Statistiche aggiornamento prezzi</a>
    </div>

    <h1>Statistiche aggiornamento prezzi</h1>
    <div class="form-container">
        <div class="form-group">
            <label for="fromDate">Da:</label>
            <input type="date" id="fromDate">
        </div>
        <div class="form-group">
            <label for="toDate">A:</label>
            <input type="date" id="toDate">
        </div>
        <div class="form-group">
            <label for="vendor">Fornitore:</label>
            <select id="vendor"></select>
        </div>
        <div class="form-group-row">
            <button onclick="fetchPriceChanges()">Visualizza Cambiamenti di Prezzo</button>
        </div>
        <div class="form-group-row">
            <button style="background-color: #dc3545;" onclick="forcePriceUpdate()">Forza Aggiornamento Prezzi</button>
        </div>
    </div>

    <div class="loading-bar" id="loadingBar" style="display: none;">
        <div class="loading-bar-fill" id="loadingBarFill">0%</div>
    </div>

    <div id="stats" class="stats"></div>

    <div id="priceChangesSidebar" class="price-changes-sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closePriceChanges()">&times;</a>
        <h2>Cambiamenti di prezzo per <span id="vendorName"></span></h2>
        <div id="priceChangesHeader"></div>
        <div id="priceChangesContent"></div>
    </div>

    <script>
        function openNav() {
            document.getElementById("mySidebar").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
        }

        function openPriceChanges() {
            document.getElementById("priceChangesSidebar").style.width = "400px";
        }

        function closePriceChanges() {
            document.getElementById("priceChangesSidebar").style.width = "0";
        }

        function fetchVendors() {
            fetch('/get-vendors')
            .then(response => response.json())
            .then(data => {
                const vendorSelect = document.getElementById('vendor');
                vendorSelect.innerHTML = data.vendors.map(vendor => `<option value="${vendor}">${vendor}</option>`).join('');
            })
            .catch(error => {
                alert('Errore nella richiesta dei fornitori: ' + error.message);
            });
        }

        function fetchPriceChanges() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const vendor = document.getElementById('vendor').value;
            let url = `/get-price-change-report?vendor=${vendor}`;
            if (fromDate) {
                url += `&from_date=${fromDate}`;
            }
            if (toDate) {
                url += `&to_date=${toDate}`;
            }
            fetch(url)
            .then(response => response.json())
            .then(data => {
                const priceChangesContent = document.getElementById('priceChangesContent');
                const priceChangesHeader = document.getElementById('priceChangesHeader');
                const vendorName = document.getElementById('vendorName');
                vendorName.textContent = vendor;

                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                const fromDateFormatted = new Date(fromDate).toLocaleDateString('it-IT', options);
                const toDateFormatted = new Date(toDate).toLocaleDateString('it-IT', options);

                priceChangesHeader.innerHTML = `<p>${data.price_changes.length} risultati per il fornitore ${vendor} dal ${fromDateFormatted} al ${toDateFormatted}</p>`;
                priceChangesContent.innerHTML = '';

                if (data.price_changes.length === 0) {
                    priceChangesContent.innerHTML = '<p>Nessun cambiamento di prezzo trovato.</p>';
                } else {
                    data.price_changes.forEach(change => {
                        const oldPrice = parseFloat(change.old_price.replace(/[^0-9,]/g, '').replace(',', '.'));
                        const newPrice = parseFloat(change.new_price.replace(/[^0-9,]/g, '').replace(',', '.'));
                        if (oldPrice !== newPrice) {
                            priceChangesContent.innerHTML += `
                                <div class="price-change">
                                    <p class="timestamp">Data: ${new Date(change.timestamp).toLocaleString('it-IT', options)}</p>
                                    <p class="product-title">Prodotto: ${change.product_title}</p>
                                    <p class="product-url">URL: <a href="${change.url}" target="_blank">${change.url}</a></p>
                                    <p class="old-price">Vecchio Prezzo: €${change.old_price}</p>
                                    <p class="new-price">Nuovo Prezzo: €${change.new_price}</p>
                                </div>
                            `;
                        }
                    });
                }

                openPriceChanges();
            })
            .catch(error => {
                alert('Errore nella richiesta: ' + error.message);
            });
        }

        function forcePriceUpdate() {
            const secret = 'seceythatishardtoguessdrvsserzerfcc';  // Replace with your actual secret
            const loadingBar = document.getElementById('loadingBar');
            const loadingBarFill = document.getElementById('loadingBarFill');

            loadingBar.style.display = 'block';
            loadingBarFill.style.width = '0%';
            loadingBarFill.textContent = '0%';

            fetch('/update-prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ secret })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const statsContainer = document.getElementById('stats');
                    statsContainer.innerHTML = `
                        <p>Prodotto aggiornati: ${data.stats.total_updates}</p>
                        <p>Prodotti con prezzi invariati: ${data.stats.unchanged}</p>
                        <p>Prodotti con prezzi variati: ${data.stats.varied} <button onclick="fetchUpdateResults()">Vedi prodotti</button></p>
                    `;
                } else {
                    alert(`Errore nell'aggiornamento dei prezzi: ${data.message}`);
                }
                loadingBar.style.display = 'none';
            })
            .catch(error => {
                alert('Errore nella richiesta di aggiornamento: ' + error.message);
                loadingBar.style.display = 'none';
            });
        }

        function fetchUpdateResults() {
            fetch('/get-update-results')
            .then(response => response.json())
            .then(data => {
                const priceChangesContent = document.getElementById('priceChangesContent');
                const priceChangesHeader = document.getElementById('priceChangesHeader');

                priceChangesHeader.innerHTML = `<p>Totale aggiornamenti: ${data.varied + data.unchanged}, Prezzi variati: ${data.varied}, Prezzi invariati: ${data.unchanged}</p>`;
                priceChangesContent.innerHTML = '';

                if (data.price_changes.length === 0) {
                    priceChangesContent.innerHTML = '<p>Nessun cambiamento di prezzo trovato.</p>';
                } else {
                    data.price_changes.forEach(change => {
                        priceChangesContent.innerHTML += `
                            <div class="price-change">
                                <p class="timestamp">Data: ${new Date(change.timestamp).toLocaleString('it-IT')}</p>
                                <p class="product-title">Prodotto: ${change.product_title}</p>
                                <p class="product-url">URL: <a href="${change.url}" target="_blank">${change.url}</a></p>
                                <p class="old-price">Vecchio Prezzo: €${change.old_price}</p>
                                <p class="new-price">Nuovo Prezzo: €${change.new_price}</p>
                            </div>
                        `;
                    });
                }

                openPriceChanges();
            })
            .catch(error => {
                alert('Errore nella richiesta dei risultati: ' + error.message);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchVendors);
    </script>
</body>
</html>
